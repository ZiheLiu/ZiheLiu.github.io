---
title: ZooKeeper 基本概念
date: 2020-03-06 20:38:00
categories:
	- 分布式
tags:
	- 分布式
typora-root-url: ../../
---

# 引用

- [Zookeeper 系列（一）基本概念](https://www.cnblogs.com/binarylei/p/8721126.html)

- [深入浅出Zookeeper（二） 基于Zookeeper的分布式锁与领导选举](http://www.jasongj.com/zookeeper/distributedlock/)

# 属性结构

ZooKeeper 使用类似文件系统的方式组织数据。

每个节点用从根节点到它的绝对路径表示 `/node1/node12`。

其中 `/zookeeper` 用以保存管理信息，比如关键配额信息。

# Znode

每个节点用 Znode 表示，兼具文件和目录两种特点。

由 3 部分组成:

- **stat** ：状态信息, 描述该 Znode 的版本、权限等信息
- **data** ：关联的数据。最多为 1M。主要做配置、状态管理，不要用来存储大数据。
- **children** ：子节点。

# 数据访问

原子操作。

读操作获取与节点相关的所有数据。

写操作替换掉节点的所有数据。

每一个节点有 ACL(访问控制列表)，这个列表规定了用户的权限，限定了特定用户对目标节点可以执行的操作。

# 节点类型

## Persist 与 Ephemeral

- Persist 节点，一旦被创建，便不会意外丢失，即使服务器全部重启也依然存在。每个 Persist 节点即可包含数据，也可包含子节点
- Ephemeral 点，在创建它的客户端与服务器间的 Session 结束时自动被删除。服务器重启会导致 Session 结束，因此 Ephemeral 类型的 znode 此时也会自动删除。

## Sequence 与 Non-sequence
  - Non-sequence 节点，多个客户端同时创建同一 Non-sequence 节点时，只有一个可创建成功，其它匀失败。并且创建出的节点名称与创建时指定的节点名完全一样
  - Sequence 节点，创建出的节点名在指定的名称之后带有10位10进制数的序号。多个客户端创建同一名称的节点时，都能创建成功，只是序号不同

# Zookeeper语义保证

Zookeeper 简单高效，同时提供如下语义保证，从而使得我们可以利用这些特性提供复杂的服务。

- 顺序性。客户端发起的更新会按发送顺序被应用到 Zookeeper 上。
- 原子性。 更新操作要么成功要么失败，不会出现中间状态。
- 单一系统镜像。一个客户端无论连接到哪一个服务器都能看到完全一样的系统镜像。
  - 写操作并不保证更新被所有的 Follower 立即确认，因此通过部分 Follower 读取数据并不能保证读到最新的数据，而部分 Follwer 及 Leader 可读到最新数据。如果一定要保证单一系统镜像，可在读操作前使用 sync 方法。
- 可靠性。一个更新操作一旦被接受即不会意外丢失，除非被其它更新操作覆盖。
- 最终一致性。写操作最终（而非立即）会对客户端可见。

# Watch机制

所有对 Zookeeper 的读操作，都可附带一个 Watch 。一旦相应的数据有变化，该 Watch 即被触发。Watch 有如下特点

- 主动推送。Watch被触发时，由 Zookeeper 服务器主动将更新推送给客户端，而不需要客户端轮询。
- 一次性。数据变化时，Watch 只会被触发一次。如果客户端想得到后续更新的通知，必须要在 Watch 被触发后重新注册一个 Watch。
- 可见性。如果一个客户端在读请求中附带 Watch，Watch 被触发的同时再次读取数据，客户端在得到 Watch 消息之前肯定不可能看到更新后的数据。换句话说，更新通知先于更新结果。
- 顺序性。如果多个更新触发了多个 Watch ，那 Watch 被触发的顺序与更新顺序一致。

# 实现分布式锁

## 简单版本

基于 ZooKeeper 实现分布式锁。

对于一个锁 `lock`，用一个节点表示。

创建这个节点的获取锁。

释放锁时删除节点。

![ZooKeeper锁1](/images/ZooKeeper锁1.svg)

### 缺点

惊群。在释放锁时，所有等待锁的节点都被唤醒。

## 改进版本

`lock` 目录下都是顺序节点，编号最小的节点获取到锁。

每个节点 watch 编号比它小 1 的节点，而不是获取锁的节点。

在前面的节点获取锁、并释放后，节点会被删除。本节点就获取到了锁。

![ZooKeeper锁2](/images/ZooKeeper锁2.svg)