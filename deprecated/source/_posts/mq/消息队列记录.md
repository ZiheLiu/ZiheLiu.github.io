---
title: 消息队列记录
date: 2020-03-11 18:30:00
categories:
	- mq
tags:
	- mq
typora-root-url: ../../
---

# 引用

- [消息队列](https://time.geekbang.org/column/intro/212)

# 消息队列作用

- 异步处理。
- 流量控制。
- 服务解耦。

## 异步处理

把不是必须马上做完的任务放到消息队列里，供后续服务异步执行。

- 可以更快地返回结果。
- 减少等待，自然实现了步骤之间的并发，提升系统总体的性能。
- 在流量高峰期，可以使服务资源先满足前面必须的操作。

![img](/images/d2c1ee3d4478580c0d2a8d80d0e833be.jpg)

## 流量控制

使用消息队列隔离网关和后端服务，以达到流量控制、保护后端服务的目的。

![img](/images/7909fb792a059e22a0a269c1f2cde64a.jpg)

### 处理流程

这样改为异步操作后，需要修改处理流程

- 网关在把消息放入消息队列后，需要阻塞等待。
- 直到后端服务处理结束，把结果通过 RPC 返回给网关。

### 超时处理

APP 端可能会设置 `timeout` 时间后，请求超时。

可以在消息中存储一个超时的时间戳，后端服务拿到消息后，先判断是否超时了，再做处理。

### 令牌桶

上面的流量控制方案，需要整个系统都改为异步的方式。

可以换一种方案，使用消息队列作为令牌桶。

- 令牌发生器定时放令牌到消息队列中。

- 网关服务在把请求发给后端时，需要先从消息队列取出一个消息。

![img](/images/2c4e42056b78fff7746de28245910f89.jpg)

## 服务解耦

对于一个服务，会依赖众多下游服务。应对不断变化的下游服务、及他们的接口，上游服务也要不断的调整变化，服务耦合度太高。

可以上游服务把消息放到消息队列，下游服务都订阅这个 Topic。

# 消息队列简单对比

## RabbitMQ

### 优点

- 轻量级
- 迅捷
- 支持非常灵活的路由配置。在 Producer 和 Queue 之间增加了 Exchange。

### 缺点

- 对消息堆积的支持并不好
- 性能较差（几万-十几万条消息/秒）。
- 不易二次开发（Erlang）。

## RocketMQ
### 优点

- 性能好。（几十万条消息/秒）。

- 稳定性和可靠性高。
- 对在线业务的响应时延做了很多的优化。

### 缺点

在国际上还没有那么流行，与周边生态系统的集成和兼容程度要略逊一筹。

## kafka
### 优点

- 性能好。（几十万条消息/秒）。
- 稳定性和可靠性高。
- 吞吐量大。异步批量处理。

### 缺点

“先攒一波再一起处理”。同步收发消息的响应时延比较高。