---
title: 3. 网络层
date: 2020-03-05 19:01:00
categories:
	- network
tags:
	- network
typora-root-url: ../
---

# 引用

- [数据帧，数据报，数据包相互关系包含关系的理解](https://zhuanlan.zhihu.com/p/62104550)

# IP协议首部的部分字段

1. 源地址
2. 目标地址
3. 标识：在数据报长度过长时，要进行分片，相同数据报的不同分片的标识相同。
4. 片偏移：单位为8个字节，在需要分片时和标识一起使用。

# IP 数据分片

如果要传输的数据包大小超过 1500B，需要 IP 层把数据包分片，使得每一片都小于 1500B。

但是正常情况下要避免在网络层分片：

- 原因是IP层是没有超时重传机制的，如果IP层对一个数据包进行了分片，只要有一个分片丢失了，只能依赖于传输层进行重传，结果是所有的分片都要重传一遍，这个代价有点大。

所以UDP：对于UDP包，我们需要**在应用层**去限制每个包的大小，一般不要超过1472字节，即 `以太网MTU - UDP首部 - IP首部` = `1500 - 8 - 20`。

TCP：对于TCP数据，**应用层就不需要考虑**这个问题了，因为传输层已经帮我们做了。在建立连接的三次握手的过程中，连接双方会相互通告 MSS（Maximum Segment Size，最大报文段长度），MSS 一般是 `MTU - IP首部 - TCP首部` = `1500 - 20 - 20`。每次发送的TCP数据都不会超过双方 MSS 的最小值，所以就保证了 IP 数据报不会超过 MTU，避免了 IP 分片

# IP地址

IP地址共4个字节，

IP地址 = `<网络号> <主机号>`，分为：

- A类地址：0开头，网络号8位，主机号24位
- B类地址：10开头，网络号16位，主机号16位
-  C类地址：110开头，网络号24位，主机号8位。
-  D类地址：1110开头，多播地址 #TODO。
- E类地址：11110开头，保留，为以后使用。

# 子网划分

​    从主机号中分出一部分用来表示子网号，需要和子网掩码配合使用。子网掩码为1的bit位说明是主机号或子网号。例如B类地址默认子网掩码为255.255.0.0。

# NAT

NAT网络地址转换协议，把内网请求的源IP地址替换为整个公网IP的地址。位置在网关出。

# NAPT

NAPT网络地址端口转换协议，要把源端口也替换为一个没有在使用的端口。修改TCP的数据包？

使用NAPT（网络地址端口转换），内网客户端可以向外网服务发请求、并收到回复。

内网客户端发起请求后，到NAT网关，会把数据包中的IP替换成自己的ip、port替换成一个空闲的port。

NAT网关有一张映射表，存储了内网数据包的IP:PORT和替换后的IP:PORT的映射关系。这样收到回复时，NAT网关可以找到真正的客户端。