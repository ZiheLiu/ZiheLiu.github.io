---
title: 代理服务的负载均衡方案
date: 2020-03-16 15:21:00
categories:
	- 系统设计
tags:
	- 系统设计
	- proxy
mathjax: true
typora-root-url: ../../
---

# 引用

- [讲讲亿级PV的负载均衡架构](https://zhuanlan.zhihu.com/p/61847281)
- [LVS 四种工作模式原理、优缺点比较及简单配置](https://blog.csdn.net/Running_free/article/details/77981201)
- [Dubbo的负载均衡](http://dubbo.apache.org/zh-cn/blog/dubbo-loadbalance.html)
- [聊聊一致性哈希](https://zhuanlan.zhihu.com/p/24440059)

# DNS + LVS + Nginx

1. 首先使用 DNS 做负载均衡。

2. 两个 LVS 服务，每个使用 Keepalived 主从备份。

3. 每个 LVS 把请求转发到多个 Nginx 上。

4. Nginx 根据路由等规则，转发请求。

![img](/images/v2-f03c630e810762314f0b8aa877d6d1a9_1440w.jpg)

图来自[讲讲亿级PV的负载均衡架构](https://zhuanlan.zhihu.com/p/61847281)

# LVS

LVS Linux Virtual Server，工作在网络层。

具体四种工作模式请见 [LVS 四种工作模式原理、优缺点比较及简单配置](https://blog.csdn.net/Running_free/article/details/77981201)。

# 负载均衡算法

## Dubbo 中的负载均衡算法

1. 加权随机
2. 加权轮询
3. 最少活跃调用数
4. 一致性 Hash
   - 相同参数的请求总是发到同一 Provider。
   - 使用虚拟节点，hash 后找到距离最近的 Provider。

## 一致性哈希

> [聊聊一致性哈希](https://zhuanlan.zhihu.com/p/24440059)

哈希节点做成环状，有虚拟节点和真实的节点。

每个真实节点负责它逆时针到上一个真实节点期间的虚拟节点。

环的节点数目为 $n$ 个，则查找一个节点的真实节点需要 $O(n)$ 的时间复杂度。

可以使每个真实节点记录距离自己 $2^0$、$2^1$ ... $2^k$ 的节点所对应的真实节点，每次更新和查找都是 $O(logn)$ 的时间复杂度。

